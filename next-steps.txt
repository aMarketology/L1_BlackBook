# Next Steps: L1-L2 Time Anchoring & Settlement

## 0. FOUNDATION: True Genesis Block (Priority) ✅ DONE
We must fix the non-deterministic genesis block to ensure a stable chain.
- [x] **Implement Deterministic Genesis**
    - Replace `SystemTime` seed with hash of `MANIFESTO.md`.
    - **Treasury Only:** Initialize ONLY the Treasury/Mint account (e.g., 1B tokens).
    - **Governance State:** Initialize a Config Account for parameters (engagement weights, inflation).
    - Remove hardcoded user accounts (Alice/Bob) from genesis logic.
    - Define `GENESIS_HASH` constant for network discovery.

## 1. L2 Time Anchoring (Proof of History Integration) ✅ DONE
The goal is to cryptographically bind L2 bets to the L1 timeline to prevent front-running and prove bet timing.

- [x] **Update L2 Server (`/bet` endpoint)**
    - Add optional `l1_anchor_hash` field to the bet payload.
    - Store this hash with the bet receipt.
    - Validate that the hash is recent (optional, requires L1 query).

- [x] **Update SDK (`L2Client.placeBet`)**
    - Fetch latest L1 blockhash (`l1Client.getBlockHeight()`) before placing a bet.
    - Include this hash in the `/bet` request.

- [ ] **Verify Anchoring**
    - Create a test that places a bet and verifies the receipt contains the L1 hash.
    - Prove that the bet happened *after* the L1 block was mined.

## 2. Settlement & Withdrawal (The "Cash Out" Flow)
We have betting working, now we need to let users take their profits back to L1.

- [ ] **Implement Market Resolution (L2)**
    - Create an admin endpoint on L2 to resolve a market (e.g., `POST /resolve`).
    - Calculate winnings for all positions.
    - Update user L2 balances.

- [x] **Implement Bridge Release (L2 -> L1)**
    - Create `withdraw()` function in SDK. ✅
    - Create `settleSession()` function in SDK. ✅
    - **Step A:** L2 burns the tokens and generates a `SettlementProof` (signature).
    - **Step B:** SDK submits this proof to L1 (`SettlementNode.ReleaseBridgeFunds`).
    - **Step C:** L1 verifies the proof and unlocks the funds to the user's L1 wallet.
    - Note: `/session/settle` endpoint already exists in bridge.rs ✅

- [ ] **End-to-End "Cash Out" Test**
    - Alice wins 100 BB on L2.
    - Alice requests withdrawal.
    - Verify Alice's L1 balance increases by 100 BB.
    - Verify Alice's L2 balance decreases to 0.

## 3. Frontend Integration (Optional)
- [ ] Connect the `UnifiedWallet` SDK to a simple UI.
- [ ] Display L1 vs L2 balances.
- [ ] Show real-time market prices from L2.

## 4. Production Hardening
- [ ] **Signature Verification:** Enable the actual Ed25519 verification in `validator.rs` (currently returns `true` for testing).
- [ ] **Replay Protection:** Enable nonce/timestamp checking on L2.
